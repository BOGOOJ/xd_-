// 12864j液晶显示器
#define WR_COM_AD_L		0x264				//写左半屏指令地址  
#define WR_COM_AD_R		0x260				//写右半屏指令地址
#define WR_DATA_AD_L 	0x266				//写左半屏数据地址	
#define WR_DATA_AD_R	0x262				//写右半屏数据地址
#define RD_BUSY_AD 		0x261				//查忙地址
#define RD_DATA_AD 		0x263				//读数据地址

#define X 			0xB8							//起始显示行基址
#define Y			0x40							//起始显示列基址
#define FirstLine	0xC0							//起始显示行

extern void outportb( unsigned int, char); //输出字节到硬件端口中
extern char inportb( unsigned int ); //从指定硬件端口读入一个字节



//--  文字: 密  --
unsigned char Line1_1[] = {		
		0x10,0x8C,0x44,0x04,0xE4,0x04,0x95,0xA6,0x44,0x24,0x14,0x84,0x44,0x94,0x0C,0x00,
        	0x02,0x02,0x7A,0x41,0x41,0x43,0x42,0x7E,0x42,0x42,0x42,0x43,0xF8,0x00,0x00,0x00};
//--  文字: 码  --
unsigned char Line1_2[] = {
		0x04,0x84,0xE4,0x5C,0x44,0xC4,0x00,0x02,0xF2,0x82,0x82,0x82,0xFE,0x80,0x80,0x00,
        0x02,0x01,0x7F,0x10,0x10,0x3F,0x00,0x08,0x08,0x08,0x08,0x48,0x88,0x40,0x3F,0x00};
//--  文字: 错  --
unsigned char Line1_3[] = {
		0x40,0x30,0xEF,0x24,0x64,0x48,0x48,0x7F,0x48,0x48,0x48,0x7F,0x48,0x48,0x40,0x00,
       	 	0x01,0x01,0x7F,0x21,0x11,0x00,0xFF,0x49,0x49,0x49,0x49,0x49,0xFF,0x00,0x00,0x00};
//--  文字: 误  --
unsigned char Line1_4[] = {
		0x40,0x42,0xCC,0x00,0x00,0x80,0x9E,0x92,0x92,0x92,0x92,0x92,0x9E,0x80,0x00,0x00,
        	0x00,0x00,0x7F,0x20,0x94,0x84,0x44,0x24,0x14,0x0F,0x14,0x24,0x44,0x84,0x84,0x00};
        
//--  文字: 正  --
unsigned char Line1_5[] = {
		0x00,0x02,0x02,0xC2,0x02,0x02,0x02,0xFE,0x82,0x82,0x82,0x82,0x82,0x02,0x00,0x00,
           	0x40,0x40,0x40,0x7F,0x40,0x40,0x40,0x7F,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00};
//--  文字: 确  --
unsigned char Line1_6[] = {
		0x04,0x84,0xE4,0x5C,0x44,0xC4,0x20,0x10,0xE8,0x27,0x24,0xE4,0x34,0x2C,0xE0,0x00,
		0x02,0x01,0x7F,0x10,0x10,0x3F,0x80,0x60,0x1F,0x09,0x09,0x3F,0x49,0x89,0x7F,0x00};

//--  文字: 系  --
unsigned char Line2_1[] = {
		0x00,0x00,0x22,0x32,0x2A,0xA6,0xA2,0x62,0x21,0x11,0x09,0x81,0x01,0x00,0x00,0x00,
		0x00,0x42,0x22,0x13,0x0B,0x42,0x82,0x7E,0x02,0x02,0x0A,0x12,0x23,0x46,0x00,0x00};

//--  文字: 统  --
unsigned char Line2_2[] = {
		0x20,0x30,0xAC,0x63,0x30,0x00,0x88,0xC8,0xA8,0x99,0x8E,0x88,0xA8,0xC8,0x88,0x00,
		0x22,0x67,0x22,0x12,0x12,0x80,0x40,0x30,0x0F,0x00,0x00,0x3F,0x40,0x40,0x71,0x00};

//--  文字: 锁  --
unsigned char Line2_3[] = {
		0x20,0x10,0x2C,0xE7,0x24,0x24,0x00,0xE2,0x2C,0x20,0xBF,0x20,0x28,0xE6,0x00,0x00,
		0x01,0x01,0x01,0x7F,0x21,0x11,0x80,0x4F,0x20,0x10,0x0F,0x10,0x20,0x4F,0x80,0x00};

//--  文字: 定  --
unsigned char Line2_4[] = {
		0x10,0x0C,0x44,0x44,0x44,0x44,0x45,0xC6,0x44,0x44,0x44,0x44,0x44,0x14,0x0C,0x00,
		0x80,0x40,0x20,0x1E,0x20,0x40,0x40,0x7F,0x44,0x44,0x44,0x44,0x44,0x40,0x40,0x00};

//--  文字: 开  --
unsigned char Line3_1[] = {
		0x80,0x82,0x82,0x82,0xFE,0x82,0x82,0x82,0x82,0x82,0xFE,0x82,0x82,0x82,0x80,0x00,
		0x00,0x80,0x40,0x30,0x0F,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00};

//--  文字: 放  --
unsigned char Line3_2[] = {
		0x08,0x08,0xF9,0x4A,0x48,0xC8,0x48,0x20,0xD8,0x17,0x10,0x10,0xF0,0x10,0x10,0x00,
		0x40,0x30,0x0F,0x20,0x40,0x3F,0x80,0x40,0x21,0x16,0x08,0x16,0x21,0x40,0x80,0x00};

//--  文字: 输  --
unsigned char Line3_3[] = {
		0x88,0x68,0x1F,0xC8,0x08,0x10,0xC8,0x54,0x52,0xD1,0x12,0x94,0x08,0xD0,0x10,0x00,
		0x09,0x19,0x09,0xFF,0x05,0x00,0xFF,0x12,0x92,0xFF,0x00,0x5F,0x80,0x7F,0x00,0x00};

//--  文字: 入  --
unsigned char Line3_4[] = {
		0x00,0x00,0x00,0x00,0x00,0x01,0xE2,0x1C,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x80,0x40,0x20,0x10,0x0C,0x03,0x00,0x00,0x00,0x03,0x0C,0x30,0x40,0x80,0x80,0x00};

//--  文字: 修  --
unsigned char Line4_1[] = {
		0x40,0x20,0xF8,0x07,0xF0,0xA0,0x90,0x4C,0x57,0x24,0xA4,0x54,0x4C,0x80,0x80,0x00,
		0x00,0x00,0xFF,0x00,0x1F,0x80,0x92,0x52,0x49,0x29,0x24,0x12,0x08,0x00,0x00,0x00};

//--  文字: 改  --
unsigned char Line4_2[] = {
		0x04,0x84,0x84,0x84,0x84,0xFC,0x40,0x30,0xCC,0x0B,0x08,0x08,0xF8,0x08,0x08,0x00,
		0x00,0x7F,0x20,0x10,0x10,0x08,0x80,0x40,0x21,0x16,0x08,0x16,0x21,0x40,0x80,0x00};

//--  文字: 成  --
unsigned char Line4_3[] = {
		0x00,0x00,0xF8,0x88,0x88,0x88,0x88,0x08,0x08,0xFF,0x08,0x09,0x0A,0xC8,0x08,0x00,
		0x80,0x60,0x1F,0x00,0x10,0x20,0x1F,0x80,0x40,0x21,0x16,0x18,0x26,0x41,0xF8,0x00};

//--  文字: 功  --
unsigned char Line4_4[] = {
		0x08,0x08,0x08,0xF8,0x08,0x08,0x08,0x10,0x10,0xFF,0x10,0x10,0x10,0xF0,0x00,0x00,
		0x10,0x30,0x10,0x1F,0x08,0x88,0x48,0x30,0x0E,0x01,0x40,0x80,0x40,0x3F,0x00,0x00};

//--  符号：*   --
unsigned char Line5_1[] = {
		0x00,0x00,0x84,0x88,0x90,0xA0,0xC0,0xFC,0xC0,0xA0,0x90,0x88,0x84,0x80,0x00,0x00,
        	0x00,0x00,0x10,0x08,0x04,0x02,0x01,0x1F,0x01,0x02,0x04,0x08,0x10,0x00,0x00,0x00};
        	
//--  符号：输   --
unsigned char Line6_1[] = {
		0x88,0x68,0x1F,0xC8,0x08,0x10,0xC8,0x54,0x52,0xD1,0x12,0x94,0x08,0xD0,0x10,0x00,
		0x09,0x19,0x09,0xFF,0x05,0x00,0xFF,0x12,0x92,0xFF,0x00,0x5F,0x80,0x7F,0x00,0x00};

//--  符号：入   --
unsigned char Line6_2[] = {
		0x00,0x00,0x00,0x00,0x00,0x01,0xE2,0x1C,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x80,0x40,0x20,0x10,0x0C,0x03,0x00,0x00,0x00,0x03,0x0C,0x30,0x40,0x80,0x80,0x00};

//--  符号：按   --
unsigned char Line6_3[] = {
		0x10,0x10,0x10,0xFF,0x90,0x20,0x98,0x88,0x88,0xE9,0x8E,0x88,0x88,0xA8,0x98,0x00,
		0x02,0x42,0x81,0x7F,0x00,0x00,0x80,0x84,0x4B,0x28,0x10,0x28,0x47,0x80,0x00,0x00};

//--  符号：键   --
unsigned char Line6_4[] = {
		0x40,0x30,0xEF,0x24,0x24,0x80,0xE4,0x9C,0x10,0x54,0x54,0xFF,0x54,0x7C,0x10,0x00,
		0x01,0x01,0x7F,0x21,0x51,0x26,0x18,0x27,0x44,0x45,0x45,0x5F,0x45,0x45,0x44,0x00};
		
//--  符号：再   --
unsigned char Line7_1[] = {
		0x02,0x02,0xF2,0x92,0x92,0x92,0x92,0xFE,0x92,0x92,0x92,0x92,0xF2,0x02,0x02,0x00,
		0x04,0x04,0xFF,0x04,0x04,0x04,0x04,0x07,0x04,0x04,0x44,0x84,0x7F,0x04,0x04,0x00};

//--  符号：次   --
unsigned char Line7_2[] = {
		0x00,0x02,0x0C,0x80,0x60,0x80,0x40,0x30,0x0F,0xC8,0x08,0x08,0x28,0x18,0x00,0x00,
		0x02,0x02,0x7E,0x01,0x80,0x40,0x20,0x18,0x06,0x01,0x06,0x18,0x20,0x40,0x80,0x00};

//--  符号：新   --		
unsigned char Line8_1[] ={
		0x40,0x44,0x54,0x65,0xC6,0x64,0x54,0x44,0x00,0xFC,0x44,0x44,0xC4,0x42,0x40,0x00,
		0x20,0x12,0x4A,0x82,0x7F,0x02,0x0A,0x92,0x60,0x1F,0x00,0x00,0xFF,0x00,0x00,0x00};
//--  符号：旧   --
unsigned char Line8_2[] ={
		0x00,0x00,0xFF,0x00,0x00,0x00,0xFE,0x82,0x82,0x82,0x82,0x82,0x82,0xFE,0x00,0x00,
		0x00,0x00,0xFF,0x00,0x00,0x00,0x7F,0x20,0x20,0x20,0x20,0x20,0x20,0x7F,0x00,0x00};
//--  符号：的   --
unsigned char Line8_3[] ={
		0x00,0xF8,0x0C,0x0B,0x08,0x08,0xF8,0x40,0x30,0x8F,0x08,0x08,0x08,0xF8,0x00,0x00,
		0x00,0x7F,0x21,0x21,0x21,0x21,0x7F,0x00,0x00,0x00,0x43,0x80,0x40,0x3F,0x00,0x00};
//--  符号：重   --
unsigned char Line9_1[] = {
		0x10,0x10,0x14,0xD4,0x54,0x54,0x54,0xFC,0x52,0x52,0x52,0xD3,0x12,0x10,0x10,0x00,
		0x40,0x40,0x50,0x57,0x55,0x55,0x55,0x7F,0x55,0x55,0x55,0x57,0x50,0x40,0x40,0x00};
//--  符号：置   --	
unsigned char Line9_2[] = {
		0x00,0x17,0x15,0xD5,0x55,0x57,0x55,0x7D,0x55,0x57,0x55,0xD5,0x15,0x17,0x00,0x00,
		0x40,0x40,0x40,0x7F,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x7F,0x40,0x40,0x40,0x00};


		
//***************************************
//基本控制		
//***************************************					
//写左半屏控制指令
void WRComL(unsigned char _data)
{
	outportb(WR_COM_AD_L, _data);
	while (inportb(RD_BUSY_AD) & 0x80)	//检查液晶显示是否处于忙状态
	{;}
}

//写右半屏控制指令
void WRComR(unsigned char _data)
{
	outportb(WR_COM_AD_R, _data);
	while (inportb(RD_BUSY_AD) & 0x80)	//检查液晶显示是否处于忙状态
	{;}
}

//写左半屏数据
void WRDataL(unsigned char _data)
{
	outportb(WR_DATA_AD_L, _data);
	while (inportb(RD_BUSY_AD) & 0x80)	//检查液晶显示是否处于忙状态
	{;}
}

//写右半屏数据
void WRDataR(unsigned char _data)
{
	outportb(WR_DATA_AD_R, _data);
	while (inportb(RD_BUSY_AD) & 0x80)	//检查液晶显示是否处于忙状态
	{;}
}

//显示左半屏数据，count-显示数据个数
void DisplayL(unsigned char *pt, char count)
{
	while (count--)
	{
		WRDataL(*pt++);			//写左半屏数据
	}
}

//显示右半屏数据，count-显示数据个数
void DisplayR(unsigned char * pt, char count)
{
	while (count--)
	{
		WRDataR(*pt++);			//写右半屏数据
	}
}

//设置左半屏起始显示行列地址,x-X起始行序数(0-7)，y-Y起始列序数(0-63)
void SETXYL(unsigned char x, unsigned char y)
{
	WRComL(x+X);				//行地址=行序数+行基址
	WRComL(y+Y);				//列地址=列序数+列基址
}

//设置右半屏起始显示行列地址,x:X起始行序数(0-7)，y:Y起始列序数(0-63)
void SETXYR(unsigned char x, unsigned char y)
{
	WRComR(x+X);				//行地址=行序数+行基址
	WRComR(y+Y);				//列地址=列序数+列基址
}

//***************************************
//显示图形		
//***************************************
//显示左半屏一行图形,A-X起始行序数(0-7)，B-Y起始列地址序数(0-63)
void LineDisL(unsigned char x, unsigned char y, unsigned char * pt)
{
	SETXYL(x,y);				//设置起始显示行列
	DisplayL(pt, 64);			//显示数据
}

//显示右半屏一行图形,A-X起始行地址序数(0-7)，B-Y起始列地址序数(0-63)
void LineDisR(unsigned char x, unsigned char y, unsigned char * pt)
{
	SETXYR(x,y);				//设置起始显示行列
	DisplayR(pt, 64);			//显示数据
}

//***************************************
//显示字体，显示一个数据要占用X行两行位置
//***************************************
//右半屏显示一个字节/字：x-起始显示行序数X(0-7)；y-起始显示列序数Y(0-63)；pt-显示字数据首地址
void ByteDisR(unsigned char x, unsigned char y,unsigned char * pt)
{
	SETXYR(x,y);			//设置起始显示行列地址
	DisplayR(pt, 8);			//显示上半行数据
	SETXYR(x+1,y);			//设置起始显示行列地址
	DisplayR(pt+8, 8);		//显示下半行数据
}

void WordDisR(unsigned char x, unsigned char y,unsigned char * pt)
{
	SETXYR(x,y);			//设置起始显示行列地址
	DisplayR(pt, 16);		//显示上半行数据
	SETXYR(x+1,y);			//设置起始显示行列地址
	DisplayR(pt+16, 16);	//显示下半行数据
}

//左半屏显示一个字节/字：x-起始显示行序数X(0-7)；y-起始显示列序数Y(0-63)；pt-显示字数据首地址
void ByteDisL(unsigned char x, unsigned char y,unsigned char * pt)
{
	SETXYL(x,y);			//设置起始显示行列地址
	DisplayL(pt, 8);		//显示上半行数据
	SETXYL(x+1,y);			//设置起始显示行列地址
	DisplayL(pt+8, 8);		//显示下半行数据
}

void WordDisL(unsigned char x, unsigned char y,unsigned char * pt)
{
	SETXYL(x,y);			//设置起始显示行列地址
	DisplayL(pt, 16);		//显示上半行数据
	SETXYL(x+1,y);			//设置起始显示行列地址
	DisplayL(pt+16, 16);	//显示下半行数据
}
//清屏
void LCDClear()
{
//清左半屏
	unsigned char x,y;
	char j;
	x = 0;						//起始行，第0行
	y = 0;						//起始列，第0列
	for (x = 0; x < 8; x++)		//共8行
	{
		SETXYL(x,y);			//设置起始显示行列地址
		j = 64;
		while (j--)
			WRDataL(0);
	}
//清右半屏
	x = 0;						//起始行，第0行
	y = 0;						//起始列，第0列
	for (x = 0; x < 8; x++)		//共8行
	{
		SETXYR(x,y);			//设置起始显示行列地址
		j = 64;
		while (j--)
			WRDataR(0);
	}
}

//液晶初始化	
void LCD_INIT()
{
	WRComL(0x3e);			//初始化左半屏，关显示
	WRComL(FirstLine);		//设置起始显示行，第0行
	WRComR(0x3e);			//初始化右半屏，关显示
	WRComR(FirstLine);		//设置起始显示行，第0行
	LCDClear();				//清屏
	WRComL(0x3f);			//开显示
	WRComR(0x3f);			//开显示
}

//第2行显示"密码错误"
void DisLine1()
{
	WordDisL(2,32,Line1_1);		//第2行,第32列，左半屏，显示一个字子程序
	WordDisL(2,48,Line1_2);
	WordDisR(2,0,Line1_3);		//右半屏，显示一个字子程序
	WordDisR(2,16,Line1_4);
}

//第2行显示"密码正确"
void DisLine2()
{
	WordDisL(2,32,Line1_1);		//第2行,第32列，左半屏，显示一个字子程序
	WordDisL(2,48,Line1_2);
	WordDisR(2,0,Line1_5);		//右半屏，显示一个字子程序
	WordDisR(2,16,Line1_6);
}

//第2行显示"系统锁定"
void DisLine3()
{
	WordDisL(2,32,Line2_1);		//第2行,第32列，左半屏，显示一个字子程序
	WordDisL(2,48,Line2_2);
	WordDisR(2,0,Line2_3);		//右半屏，显示一个字子程序
	WordDisR(2,16,Line2_4);
}

//第2行显示"开放输入"
void DisLine4()
{
	WordDisL(2,32,Line3_1);		//第2行,第32列，左半屏，显示一个字子程序
	WordDisL(2,48,Line3_2);
	WordDisR(2,0,Line3_3);		//右半屏，显示一个字子程序
	WordDisR(2,16,Line3_4);
}

//第2行显示"修改成功"
void DisLine5()
{
	WordDisL(2,32,Line4_1);		//第2行,第32列，左半屏，显示一个字子程序
	WordDisL(2,48,Line4_2);
	WordDisR(2,0,Line4_3);		//右半屏，显示一个字子程序
	WordDisR(2,16,Line4_4);
}

//第2行显示******""\
void DisLine6()
{
	WordDisL(2,16,Line1_5);
	WordDisL(2,32,Line1_5);		//第2行,第32列，左半屏，显示一个字子程序
	WordDisL(2,48,Line1_5);
	WordDisR(2,0,Line1_5);		//右半屏，显示一个字子程序
	WordDisR(2,16,Line1_5);
	WordDisR(2,32,Line1_5);
}

//第2行显示"输入按键"
void DisLine7()
{
	WordDisL(2,32,Line6_1);		//第2行,第32列，左半屏，显示一个字子程序
	WordDisL(2,48,Line6_2);
	WordDisR(2,0,Line6_3);		//右半屏，显示一个字子程序
	WordDisR(2,16,Line6_4);
}

//第2行显示输入密码"
void DisLine8()
{
	WordDisL(2,32,Line3_3);		//第2行,第32列，左半屏，显示一个字子程序
	WordDisL(2,48,Line3_4);
	WordDisR(2,0,Line1_1);		//右半屏，显示一个字子程序
	WordDisR(2,16,Line1_2);
}

//第2行显"再次输入"
void DisLine9()
{
	WordDisL(2,32,Line7_1);		//第2行,第32列，左半屏，显示一个字子程序
	WordDisL(2,48,Line7_2);
	WordDisR(2,0,Line3_3);		//右半屏，显示一个字子程序
	WordDisR(2,16,Line3_4);
}

//延时程序
void DelayTime()
{
	unsigned char i;
	unsigned int j;
	for (i = 0; i < 3; i++)
	{
		for (j = 0; j < 0xffff; j++)
		{;}
	}
}


//显示一个*
void DisLine_1()
{
	WordDisL(2,16,Line5_1);
}

//显示两个*
void DisLine_2()
{
	WordDisL(2,16,Line5_1);
	WordDisL(2,32,Line5_1);
}

//显示三个*
void DisLine_3()
{
	WordDisL(2,16,Line5_1);
	WordDisL(2,32,Line5_1);
	WordDisL(2,48,Line5_1);
}

//显示四个*
void DisLine_4()
{
	WordDisL(2,16,Line5_1);
	WordDisL(2,32,Line5_1);
	WordDisL(2,48,Line5_1);
	WordDisR(2,0,Line5_1);
}

//显示五个*
void DisLine_5()
{
	WordDisL(2,16,Line5_1);
	WordDisL(2,32,Line5_1);
	WordDisL(2,48,Line5_1);
	WordDisR(2,0,Line5_1);
	WordDisR(2,16,Line5_1);
}

//显示六个*
void DisLine_6()
{
	WordDisL(2,16,Line5_1);
	WordDisL(2,32,Line5_1);
	WordDisL(2,48,Line5_1);
	WordDisR(2,0,Line5_1);
	WordDisR(2,16,Line5_1);
	WordDisR(2,32,Line5_1);
}

//显示七个*
void DisLine_11()
{
	WordDisL(2,0,Line5_1);
	WordDisL(2,16,Line5_1);
	WordDisL(2,32,Line5_1);
	WordDisL(2,48,Line5_1);
	WordDisR(2,0,Line5_1);
	WordDisR(2,16,Line5_1);
	WordDisR(2,32,Line5_1);
}


//显示旧的密码
void DisLine_7()
{
	WordDisL(2,32,Line8_2);
	WordDisL(2,48,Line8_3);
	WordDisR(2,0,Line1_1);
	WordDisR(2,16,Line1_2);
}


//显示新的密码
void DisLine_8()
{
	WordDisL(2,32,Line8_1);
	WordDisL(2,48,Line8_3);
	WordDisR(2,0,Line1_1);
	WordDisR(2,16,Line1_2);
}


//显示重置成功
void DisLine_9()
{		
	WordDisL(2,32,Line9_1);
	WordDisL(2,48,Line9_2);
	WordDisR(2,0,Line4_3);
	WordDisR(2,16,Line4_4);
}


//显示重新输入
void DisLine_10()
{
	WordDisL(2,32,Line9_1);
	WordDisL(2,48,Line8_1);
	WordDisR(2,0,Line3_3);
	WordDisR(2,16,Line3_4);
}	


//#########################################################################################
// 8255
#define PA_Addr		0x270
#define PB_Addr		0x271
#define PC_Addr		0x272
#define	CON_Addr	0x273

#define u8	unsigned char 
#define u16	unsigned int 

extern char inportb( unsigned int );								//读I/O
extern void outportb( unsigned int, char);

u16 password = 123456; //初始密码
u16 adminpassword = 12345678; // 管理员密码
u16 tt;

u8 buffer[8] = {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10};	//置显示缓冲器初值

void delay(u16 ms)
{
	u16 i;
	while(ms--)
	{
		i = 100;
		do
		{;}while(--i);
	}
}

//扫描数码管
//void DIR()
//{
//	u8 i, dig = 0xfe;
/*	u8 SegArray[]={0xC0, 0xF9, 0xA4, 0xB0, 0x99, 0x92, 0x82, 0xF8,
			   0x80, 0x90, 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E, 0xFF}; 

	for (i = 0 ; i < 8; i++)
	{
		outportb(PA_Addr, SegArray[buffer[i]]);		//段数据
		outportb(PB_Addr, dig);						//选择数码管
		delay(3);									//延迟3ms
		outportb(PB_Addr, 0xff);
		dig = ((dig << 1) | 1);
	}
}*/

u8 AllKey()
{
	u8 i;
	outportb(PB_Addr, 0x0);
	i = (~inportb(PC_Addr) & 0x3); //  & 0000 0011
	return i;
}

u8 key()
{
	u8 i, j, keyResult;
	u8 bNoKey = 1;
	while(bNoKey)
	{
		if (AllKey() == 0)		//调用判有无闭合键函数
		{
		//	DIR();
		//	DIR();
			continue;
		}
	//	DIR();
	//	DIR();
		if (AllKey() == 0)		//调用判有无闭合键函数
			continue;
		i = 0xfe;
		keyResult = 0;
		do
		{
			outportb(PB_Addr, i);

			j = ~inportb(PC_Addr);
			if (j & 3)
			{
				bNoKey = 0;
				if (j & 2)				//1行有键闭合
					keyResult += 8;
			}
			else						//没有键按下
			{
				keyResult++;			//列计数器加1
				i = ((i << 1) | 1);
			}
		}while(bNoKey  && (i != 0xff));
	}

	if (!bNoKey)
	{
		while(AllKey())		//判断释放否
		{
		//	DIR();
		}
	}
	return keyResult;
}

void greenl()	//绿灯亮10s
{
	outportb(PA_Addr, 0xfe);  //绿灯
	delay(10000);
}

void redl()	//红灯亮5s
{
	outportb(PA_Addr, 0xfb);  //红灯
	delay(5000);
}
void yellowl()   //黄灯闪烁5s
{
	u8 i;
		for(i = 0;i < 10;i ++)
	{
		outportb(PA_Addr, 0xfd);   //黄灯
		outportb(CON_Addr,0x0e);
		delay(250);
		outportb(PA_Addr, 0xff);
		outportb(CON_Addr,0x0f);
		delay(250);
	}
}
void blackl()     //全熄灭
{
	outportb(PA_Addr, 0xff);  //全灭
	//delay(5000);
}

u16 checkpassword()       //输入密码并与原密码进行比较，如果正确那么返回1，否则返回0
{
	u16 i;
	u16 buf[6];
	u16 inputpassword = 0;
	for(i = 0;i < 6;i ++)
	{
		buf[i] = key();
		if(buf[i] == 0x0f)  //删除实现(delete)
		{
			i = -1;
			//打印 重新输
			LCD_INIT();
			DisLine_10();
			DelayTime();
			LCD_INIT();
			continue;
		}
			LCD_INIT();
			if(i == 0)DisLine_1();
			else if(i == 1)DisLine_2();
			else if(i == 2)DisLine_3();
			else if(i == 3)DisLine_4();
			else if(i == 4)DisLine_5();
			else if(i == 5)DisLine_6();
		
	}
	for(i = 0;i < 6;i ++)
	{
		inputpassword = inputpassword*10 + buf[i];
	}
	
	if(inputpassword == password)return 1;
	else return 0;
}


void changepassword()	//更改密码
{
	//打印 输入新密码
//	LCD_INIT();
//	DisLine_8();
	u16 i;
	u8 buf[6];
	u16 inputpassword = 0;
	
	
	for(i = 0;i < 6;i ++)
	{
		buf[i] = key();
		
		/*if(buf[i] == 0x0a)
		{
			i = 0;
			//打印 重新输
			LCD_INIT();
			DisLine_10();
			DelayTime();
			continue;
		}*/
			LCD_INIT();
			if(i == 0)DisLine_1();
			else if(i == 1)DisLine_2();
			else if(i == 2)DisLine_3();
			else if(i == 3)DisLine_4();
			else if(i == 4)DisLine_5();
			else if(i == 5)DisLine_6();
		
	}
	for(i = 0;i < 6;i ++)
	{
		inputpassword = inputpassword*10 + buf[i];
	}
	
	password = inputpassword;
	
}

u16 modify()       //修改密码，如果修改密码成功，那么返回1，否则返回0
{
	if(checkpassword()){
			LCD_INIT();
		DisLine_8();
		changepassword();
		return 1;}
	else return 0;
}

u16 admin()                //管理员功能,如果管理员密码输入正确,那么将开锁密码置123456,并返回1
{
	u16 i;
	u16 buf[8];
	u16 inputpassword = 0;
	for(i = 0;i < 8;i ++)
	{
		buf[i] = key();
			LCD_INIT();
			if(i == 0)DisLine_1();
			else if(i == 1)DisLine_2();
			else if(i == 2)DisLine_3();
			else if(i == 3)DisLine_4();
			else if(i == 4)DisLine_5();
			else if(i == 5)DisLine_6();
			else if(i == 6)DisLine_11();
	}
	
	for(i = 0;i < 8;i ++)
	{
		inputpassword = inputpassword*10 + buf[i];
	}
	
	if(inputpassword == adminpassword){password = 123456;return 1;}
	else return 0;
}

u16 openlock()               //a代表开锁,如果开锁成功那么返回1,如果密码错误超过三次那么返回0
{
	u16 errorcount = 0;
	u16  t;
	
	while(1)
	{
		if(errorcount >= 3)return 0;
		if(errorcount != 0 && errorcount != 3)
		{
			LCD_INIT();					
			DelayTime();
			DisLine9();
		}
		t = checkpassword();
		
		if(t){
			return 1;
		}
		else errorcount ++;
		
	}
}

/*void bibi()
{
	//outportb(CON_Addr,0x0e); 叫
	//outportb(CON_Addr,0x0f); 不叫
	
	u16 i;
	
	for(i = 0;i < 10;i ++)
	{
	outportb(CON_Addr,0x0e);
	delay(250);
	outportb(CON_Addr,0x0f);
	delay(250);	
	}
	
	
}*/
void main()
{
	
	//outportb(CON_Addr, 0x89);	//PA、PB输出，PC输入
	outportb(CON_Addr, 0x81);	//PA、PB输出，PC输入
	outportb(CON_Addr,0x0f);


	while(1)
	{
		//液晶显示 请输入按键
		LCD_INIT();					
		DelayTime();
		DisLine7();
		tt = key();
		
		if(tt == 0x0a)   //输入a，代表开锁功能	
		{
			LCD_INIT();					//输入密码
			DelayTime();
			DisLine8();
			if(openlock())
			{
				//液晶显示 开锁成功
				LCD_INIT();					//液晶初始化
				DelayTime();
				DisLine2();
				DelayTime();
				greenl();
				redl();
				blackl();
				continue;
			}
			else
			{
				//液晶显示 三次密码错误，已锁定
				LCD_INIT();					
				DelayTime();
				DisLine3();
				yellowl();
				continue;
			}
		}
		else if(tt == 0x0b) 
		{
			//打印输入原密码
			LCD_INIT();
			DisLine_7();
			//modify();
			if(modify()){
				LCD_INIT();
				DisLine5();
				DelayTime();
				}
			
		}
		else if(tt == 0x0c)    //调用admin函数，输入管理员密码，将开锁密码重置为123456
		{
			//打印输入admin密码
			LCD_INIT();
			DisLine8();
			DelayTime();
			if(admin())
			{
				LCD_INIT();
			  	DisLine_9();
			  	DelayTime();
			}
		}
	  
	}
	
	
}


